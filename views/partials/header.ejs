<header
  x-data="{ scrolled: false }"
  @scroll.window="scrolled = window.scrollY > 100"
  :class="scrolled 
      ? 'bg-white/95 shadow-sm backdrop-blur-md text-gray-800' 
      : 'bg-transparent text-primary'"
  class="fixed top-0 left-0 w-full h-[72px] z-50 flex items-center transition-all duration-500 ease-in-out"
  dir="rtl"
>
  <div
    class="max-w-7xl mx-auto flex items-center justify-between w-full px-4 md:px-6"
  >
    <!-- Logo -->
    <a href="/" class="flex items-center gap-2 group">
      <img
        src="<%= settings.assets?.logo %>"
        alt="Logo"
        class="h-9 w-auto transition-transform duration-300 group-hover:scale-105 rounded-full"
        onerror="this.src='https://placehold.co/40x40/f87171/white?text=Logo';"
      />
      <span
        class="text-lg font-semibold tracking-tight transition-colors duration-300"
        ><%= settings?.siteName?.[lang] %></span
      >
    </a>

    <div
      x-data="searchModal()"
      @keydown.ctrl.k.prevent.window="openSearch()"
      @keydown.escape.window="closeSearch()"
      class="flex-1 mx-4"
    >
      <button
        @click.prevent="openSearch()"
        aria-label="<%= __('search.open_search') %>"
        class="relative p-2 rounded-full transition-colors"
      >
        <i class="fas fa-search w-5 h-5"></i>
      </button>

      <div
        x-show="isSearchOpen"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-start justify-center pt-16 sm:pt-24 bg-black/50 backdrop-blur-sm"
        style="display: none"
      >
        <div
          @click.away="closeSearch()"
          class="relative w-full max-w-lg bg-white rounded-lg shadow-xl"
        >
          <button
            @click.prevent="closeSearch()"
            class="absolute -top-2 -right-2 w-8 h-8 flex items-center justify-center bg-gray-600 hover:bg-gray-800 text-white rounded-full z-10 transition-colors"
            aria-label="<%= __('search.close_search') %>"
          >
            <i class="fas fa-times w-5 h-5"></i>
          </button>

          <div>
            <form action="/products" method="GET" class="relative w-full">
              <input
                type="text"
                name="q"
                placeholder="<%= __('search.placeholder') %>"
                class="w-full rounded-t-lg border border-gray-300 py-4 pl-12 pr-20 text-lg text-gray-800 placeholder-gray-500 bg-white focus:outline-none focus:ring-2 focus:ring-primary/70"
                x-ref="searchInput"
                x-model="searchQuery"
                @input.debounce.300ms="getSuggestions()"
              />

              <div
                class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400"
              >
                <i class="fas fa-search w-full h-full"></i>
              </div>

              <button
                type="button"
                x-show="searchQuery.length > 0"
                @click.prevent="clearSearch()"
                class="absolute right-12 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400 hover:text-gray-600"
                aria-label="<%= __('search.clear_search') %>"
              >
                <i class="fas fa-times-circle w-5 h-5"></i>
              </button>

              <button
                type="submit"
                class="hidden"
                aria-label="<%= __('search.submit_search') %>"
              >
                <%= __('search.submit_search') %>
              </button>
            </form>
          </div>

          <div class="p-2 max-h-72 overflow-y-auto">
            <div
              x-show="isLoading"
              class="flex justify-center items-center p-4"
            >
              <i class="fas fa-spinner fa-spin h-5 w-5 text-primary"></i>
            </div>

            <template x-for="suggestion in suggestions" :key="suggestion._id">
              <a
                :href="'/products/' + suggestion._id"
                @click.prevent="navigateToSuggestion(suggestion)"
                class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
              >
                <span x-text="suggestion.name['<%= lang %>']"></span>
              </a>
            </template>
            <script>
              console.log("<%=  lang %>");
            </script>

            <div
              x-show="!isLoading && searchQuery.length > 0 && suggestions.length === 0"
              class="p-4 text-center text-gray-500"
            >
              <%= __('search.no_results') %> "<span x-text="searchQuery"></span
              >"
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // prettier-ignore
      function searchModal() {
          return {
            isSearchOpen: false,
            searchQuery:
              '<%= (typeof searchQuery !== "undefined" && searchQuery) ? searchQuery.replace(/"/g, "\\\"") : "" %>',           
            suggestions: [],
            isLoading: false,

            // --- دوال التحكم ---
            openSearch() {
              this.isSearchOpen = true;
              // (النقطة 1: عمل Focus)
              this.$nextTick(() => {
                this.$refs.searchInput.focus();
                this.$refs.searchInput.select(); // بيحدد الكلمة المكتوبة
              });
            },
            closeSearch() {
              this.isSearchOpen = false;
            },
            clearSearch() {
              this.searchQuery = "";
              this.suggestions = [];
              this.$refs.searchInput.focus();
            },

            // --- دالة جلب المقترحات ---
            async getSuggestions() {
              // لو مربع البحث فاضي، افضى المقترحات
              if (this.searchQuery.trim() === "") {
                this.suggestions = [];
                this.isLoading = false;
                return;
              }

              this.isLoading = true;

              try {
                // (النقطة 4: طلب الـ API)
                const response = await fetch(
                  `/products/api/suggest?q=${this.searchQuery}`
                );
                if (!response.ok) throw new Error("Network error");

                const data = await response.json();
                this.suggestions = data.data;
              } catch (error) {
                console.error("Error fetching suggestions:", error);
                this.suggestions = []; // فشل الطلب = إخفاء المقترحات
              }

              this.isLoading = false;
            },
            navigateToSuggestion(suggestion) {
              // 1. أغلق الـ modal
              this.closeSearch();

              // 2. جهز الرابط الحالي
              const currentUrl = new URL(window.location.href);

              // 3. شيل الـ 'q' من الرابط الحالي
              if (currentUrl.searchParams.has("q")) {
                currentUrl.searchParams.delete("q");

                // 4. حدّث الـ history بتاع المتصفح (يغير الرابط في شريط العنوان بدون reload)
                // هذا يضمن أنك لو ضغطت "Back" هترجع للرابط النظيف
                history.pushState(null, "", currentUrl.toString());
              }

              // 5. اذهب إلى صفحة المنتج
              window.location.href = "/products/" + suggestion._id;
            },
          };
        }
      // prettier-ignore
    </script>
    <!-- Nav -->
    <div class="relative" x-data="{ open: false }">
      <nav
        class="hidden md:flex items-center gap-6 font-medium transition-colors duration-300"
      >
        <!-- Language Switch Button -->
        <div class="ml-3">
          <% if (locale === 'en') { %>
          <a
            href="/switch-lang/he"
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 transition-all duration-200"
          >
            <i class="fas fa-globe w-4 h-4"></i>
            עברית
          </a>
          <% } else { %>
          <a
            href="/switch-lang/en"
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 transition-all duration-200"
          >
            <i class="fas fa-globe w-4 h-4"></i>
            English
          </a>
          <% } %>
        </div>
        <a href="/" class="hover:opacity-80 transition-opacity"
          ><%= __('nav.home') %></a
        >
        <a
          href="/products?category=inner"
          class="hover:opacity-80 transition-opacity"
          ><%= __('nav.internal_doors') %></a
        >
        <a
          href="/products?category=main"
          class="hover:opacity-80 transition-opacity"
          ><%= __('nav.external_doors') %></a
        >
        <a href="/#contact" class="hover:opacity-80 transition-opacity"
          ><%= __('nav.contact') %></a
        >
      </nav>

      <!-- Mobile Button -->
      <button
        @click="open = !open"
        class="md:hidden focus:outline-none transition-transform duration-300"
        :class="open ? 'rotate-90' : 'rotate-0'"
        aria-label="<%= __('nav.toggle_navigation') %>"
        :aria-expanded="open.toString()"
        aria-controls="mobile-menu-dropdown"
      >
        <i class="fas fa-bars h-6 w-6" x-show="!open"></i>
        <i class="fas fa-times h-6 w-6" x-show="open"></i>
      </button>

      <!-- Mobile Menu Dropdown -->
      <div
        id="mobile-menu-dropdown"
        x-show="open"
        x-transition
        @click.away="open = false"
        @keydown.escape.window="open = false"
        class="absolute left-0 mt-3 w-52 bg-white text-gray-800 border border-gray-100 rounded-lg shadow-md py-2 md:hidden"
        x-cloak
      >
        <a href="/" class="block px-4 py-2 hover:bg-gray-50"
          ><%= __('nav.home') %></a
        >
        <a
          href="/products?category=inner"
          class="block px-4 py-2 hover:bg-gray-50"
          ><%= __('nav.internal_doors') %></a
        >
        <a
          href="/products?category=main"
          class="block px-4 py-2 hover:bg-gray-50"
          ><%= __('nav.external_doors') %></a
        >
        <a href="/#contact" class="block px-4 py-2 hover:bg-gray-50"
          ><%= __('nav.contact') %></a
        >
      </div>
    </div>
  </div>
</header>
