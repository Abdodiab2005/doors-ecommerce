<div
  x-data="productPage()"
  class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 items-start mt-8 px-4 md:px-0"
>
  <div class="flex flex-col">
    <div
      class="rounded-xl mx-auto shadow-lg overflow-hidden mb-4 border border-neutral-200 w-full max-w-[200px] aspect-[9/16]"
    >
      <img
        :src="mainImage"
        alt="Door preview"
        class="w-full h-full object-cover transition-all duration-500 ease-in-out"
        loading="lazy"
        width="900"
        height="1600"
      />
    </div>

    <div class="grid grid-cols-4 sm:grid-cols-5 gap-2 xs:gap-3">
      <template x-for="(image, i) in galleryImages" :key="i">
        <div
          @click="mainImage = image"
          :class="mainImage === image
            ? 'ring-2 ring-primary ring-offset-2'
            : 'ring-1 ring-transparent hover:ring-neutral-400'"
          class="rounded-lg overflow-hidden cursor-pointer transition-all duration-200 aspect-[9/16]"
        >
          <img
            :src="image"
            class="w-full h-full object-cover"
            alt="Door thumbnail"
            loading="lazy"
            width="90"
            height="160"
          />
        </div>
      </template>
    </div>
  </div>

  <div class="flex flex-col justify-center py-4">
    <h1
      class="text-3xl md:text-4xl font-bold mb-3 text-neutral-800 flex items-start justify-between"
    >
      <div>
        <div><%= product.name[lang] %></div>
        <span class="text-xs text-primary bg-secondary px-2 py-1 rounded-full">
          <i class="fa-solid fa-tag"></i> <%= category %>
        </span>
      </div>

      <button id="shareButton" class="btn btn-ghost btn-circle">
        <i class="fa-solid fa-share-nodes text-primary text-xl"></i>
      </button>
    </h1>

    <script>
      // 1. امسك الزر
      const shareButton = document.getElementById("shareButton");

      // 2. أضف مستمع الحدث (Click)
      shareButton.addEventListener("click", async () => {

        // [تم التعديل هنا]: حذف علامات التنصيص " " الإضافية
        const shareData = {
          title: <%- JSON.stringify(product.name[lang]) %>,
          text: <%- JSON.stringify(product.description[lang]) %>,
          url: window.location.href,
        };

        // 4. تحقق إذا كان المتصفح يدعم الـ API
        if (navigator.share) {
          try {
            // 5. اطلب من المتصفح فتح قائمة المشاركة
            await navigator.share(shareData);
            console.log("Product shared successfully!");
          } catch (err) {
            console.error("Share failed:", err.message);
          }
        } else {
          // 6. [تحسين]: إضافة تنبيه للمستخدم عند النسخ
          try {
            await navigator.clipboard.writeText(window.location.href);
            alert("Link copied to clipboard!"); // إبلاغ المستخدم
          } catch (err) {
            alert("Failed to copy link.");
          }
        }
      });
    </script>

    <p class="text-base text-neutral-400 mb-6 leading-relaxed">
      <%= product.description[lang] %>
    </p>

    <div class="mb-8">
      <label class="text-sm font-semibold text-neutral-800 mb-2 block"></label>
        <%= __('product.available_colors') %></label
      >
      <div class="flex flex-wrap items-center gap-3">
        <% for (let color of product.colors) { %>
        <button
          @click='changeColor("<%= color.hex %>", <%- JSON.stringify(color.images || []) %>)'
          class="btn btn-circle btn-md border-2 border-neutral-300 transition-transform hover:scale-105"
          style="background-color: <%= color.hex %>"
          aria-label="<%= color.name %>"
        ></button>
        <% } %>
      </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-3 lg:gap-4">
      <a
        href="tel:<%= settings?.phone %>"
        class="btn btn-neutral btn-lg w-full lg:w-auto text-lg text-white"
      >
        <i class="fa-solid fa-phone"></i> <%= __('product.call_us') %>
      </a>
      <a
        href="https://wa.me/<%= (settings?.whatsapp)?.replace(/\D/g, '') %>"
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-outline btn-lg w-full lg:w-auto text-lg text-black"
      >
        <i class="fa-brands fa-whatsapp"></i> <%= __('product.whatsapp') %>
      </a>
      <a
        href="mailto:<%= settings?.email %>"
        class="btn btn-outline btn-lg w-full lg:w-auto text-lg text-black"
      >
        <i class="fa-solid fa-envelope"></i> <%= __('product.email') %>
      </a>
    </div>
  </div>
</div>

<script>
  function productPage() {
    return {
      mainImage:
        "<%= product.images && product.images.length ? product.images[0] : '' %>",
      galleryImages: <%- JSON.stringify(product.images || []) %>,
      changeColor(hex, images) {
        this.galleryImages = images.length ? images : <%- JSON.stringify(product.images || []) %>;
        this.mainImage = this.galleryImages[0];
      },
    };
  }
</script>